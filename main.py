import asyncio
import signal
import platform
from bot_core import LunchBot
import logging
import os
from bot_core import LunchBot
from handlers import setup_handlers  # –ò–º–ø–æ—Ä—Ç –∏–∑ handlers/__init__.py
from telegram.ext import MessageHandler
from config import CONFIG

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    filename='bot.log'
)

async def shutdown(bot):
    print("\nüõë –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞...")
    await bot.stop()

async def main():
    # –î–æ–±–∞–≤—å—Ç–µ –¥–ª—è —Ç–µ—Å—Ç–∞
    print("–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥–∞:")
    print("Admin IDs:", CONFIG['admin_ids'])
    print("Token:", CONFIG['token'][:5] + "...")
    
    bot = LunchBot()
    setup_handlers(bot.application)  # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    await bot.run()
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ Ctrl+C –¥–ª—è –≤—Å–µ—Ö –û–°
    if platform.system() == 'Windows':
        # –î–ª—è Windows –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ KeyboardInterrupt
        try:
            task = asyncio.create_task(bot.run())
            await task
        except asyncio.CancelledError:
            await shutdown(bot)
    else:
        # –î–ª—è Linux/Unix –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤
        loop = asyncio.get_running_loop()
        for sig in (signal.SIGTERM, signal.SIGINT):
            loop.add_signal_handler(
                sig,
                lambda s=sig: asyncio.create_task(shutdown(bot))
            )
        try:
            await bot.run()
        except asyncio.CancelledError:
            pass  # –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤ shutdown

    print("‚úÖ –†–∞–±–æ—Ç–∞ –±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞")

if __name__ == "__main__":
    try:
        if platform.system() == 'Windows':
            # –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è Windows
            async def windows_main():
                try:
                    await main()
                except KeyboardInterrupt:
                    print("\nüõë –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ")
            
            asyncio.run(windows_main())
        else:
            asyncio.run(main())
    except KeyboardInterrupt:
        print("\nüõë –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ")
    except Exception as e:
        print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {str(e)}")
